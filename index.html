<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Searchable Table (~37k rows)</title>
  <!-- Tabulator (table) -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
  <!-- PapaParse (CSV loader) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:24px 16px 12px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:28px}
    p.sub{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;max-width:1100px;margin:16px auto;padding:14px}
    .controls{display:grid;grid-template-columns:1fr 220px 1fr auto;gap:10px;align-items:center}
    .controls input,.controls select,.controls button{padding:10px 12px;border-radius:12px;border:1px solid #374151;background:#0b1220;color:var(--text)}
    .controls button{cursor:pointer}
    .kpi{display:flex;gap:20px;align-items:center;font-size:14px;color:var(--muted)}
    #table{height:72vh;border-radius:12px}
    .footer{max-width:1100px;margin:12px auto 24px;color:var(--muted);font-size:13px;padding:0 16px}
    a{color:var(--accent)}
    .progress-wrap{display:flex;flex-direction:column;gap:10px;align-items:center}
    progress{width:100%;height:16px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
<header>
  <h1>Big Table Viewer</h1>
  <p class="sub">Static page for large CSVs (~37k rows). Type to filter rows instantly. Host anywhere (e.g. GitHub Pages).</p>
</header>

<div class="card">
  <div class="controls">
    <input id="q" placeholder="Quick search (all columns)" aria-label="Global search" />
    <select id="col"></select>
    <input id="val" placeholder="Column filter (contains)" aria-label="Column filter" />
    <button id="clear">Clear</button>
  </div>
  <div class="kpi" id="kpi">Loading…</div>
</div>

<div class="card">
  <!-- Loading/progress area -->
  <div id="loading" class="progress-wrap" style="text-align:center; padding:1.5em;">
    <div id="loading-text">⏳ Preparing to load…</div>
    <progress id="loading-bar" max="100" value="0"></progress>
    <div class="mono" id="loading-detail"></div>
  </div>
  <!-- Table container (hidden until loaded) -->
  <div id="table" style="display:none;"></div>
</div>

<div class="footer">
  <p><strong>How to use:</strong> Put a <code>data.csv</code> file next to this page (first line = headers). This viewer auto-detects columns, paginates locally, and virtualizes rows for speed. For very wide tables, horizontally scroll inside the grid.</p>
</div>

<script>
  // ====== CONFIG ======
  const DATA_URL = 'data.csv'; // place your CSV here (same folder)
  const PAGE_SIZE = 25;        // rows per page

  // ====== State ======
  let table = null;
  let allData = [];
  let columns = [];

  // ====== Utilities ======
  const debounce = (fn, ms=200) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms);}; };
  const el = id => document.getElementById(id);
  function setKPI(text){ el('kpi').textContent = text; }
  function setLoading(text, detail=""){ el('loading-text').textContent = text; el('loading-detail').textContent = detail; }
  function setProgress(pct){ const bar = el('loading-bar'); bar.value = Math.max(0, Math.min(100, pct)); }

  function buildColumns(headers){
    return headers.map(h => ({ title: h, field: h, headerSort:true, widthGrow:1, hozAlign:"left", tooltip:true }));
  }

  function applyFilters(){
    const q = el('q').value.trim().toLowerCase();
    const col = el('col').value;
    const val = el('val').value.trim().toLowerCase();
    const filters = [];

    if(col && val){ filters.push({ field: col, type: "like", value: val }); }

    if(q){
      table.setFilter(function(row){
        const data = row.getData();
        for(const k in data){
          const v = data[k];
          if(v != null && String(v).toLowerCase().includes(q)) return true;
        }
        return false;
      });
    } else {
      table.clearFilter(true);
      if(filters.length){ table.setFilter(filters); }
    }

    const visible = table.getDataCount("active");
    setKPI(`${visible.toLocaleString()} / ${allData.length.toLocaleString()} rows shown`);
  }

  // ====== Fetch CSV with byte-level progress (XHR) ======
  function loadCSVWithProgress(url){
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'text';

      xhr.onprogress = (e) => {
        if(e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          setLoading('Downloading CSV…', `${(e.loaded/1e6).toFixed(2)} / ${(e.total/1e6).toFixed(2)} MB`);
          setProgress(pct);
        } else {
          setLoading('Downloading CSV…', `${(e.loaded/1e6).toFixed(2)} MB`);
          setProgress(25); // conservative baseline when total unknown
        }
      };

      xhr.onloadstart = () => { setLoading('Starting download…'); setProgress(5); };
      xhr.onerror = () => reject(new Error('Network error while downloading CSV'));
      xhr.onload = () => {
        if(xhr.status >= 200 && xhr.status < 300){ resolve(xhr.responseText); }
        else reject(new Error(`Failed to load CSV (status ${xhr.status})`));
      };
      xhr.send();
    });
  }

  // ====== Load, parse with Papa (row progress), then init table ======
  (async function init(){
    try{
      const csvText = await loadCSVWithProgress(DATA_URL);
      setLoading('Parsing CSV…'); setProgress(70);

      let rowsParsed = 0;
      const parsed = Papa.parse(csvText, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        worker: true,
        step: () => {
          rowsParsed++;
          if(rowsParsed % 1000 === 0){
            setLoading('Parsing CSV…', `${rowsParsed.toLocaleString()} rows`);
            // Nudge progress towards 90% while parsing
            const pct = Math.min(90, 70 + Math.floor(rowsParsed/1000));
            setProgress(pct);
          }
        },
        complete: (results) => {
          // Hide loading, show table
          el('loading').style.display = 'none';
          el('table').style.display = 'block';

          allData = results.data;
          const headers = results.meta.fields || Object.keys(allData[0] || {});
          columns = buildColumns(headers);

          // Populate column filter selector
          const sel = el('col');
          sel.innerHTML = '<option value="">Filter by column…</option>' + headers.map(h=>`<option value="${h}">${h}</option>`).join('');

          // Build table
          table = new Tabulator('#table', {
            data: allData,
            columns,
            layout: "fitDataStretch",
            height: "70vh",
            pagination: true,
            paginationMode: "local",
            paginationSize: PAGE_SIZE,
            paginationSizeSelector: [25, 50, 100, 250, 500],
            movableColumns: true,
            placeholder: "No rows match your filters.",
            virtualDom: true,
            progressiveRender: true,
            index: headers[0] || undefined,
          });

          setKPI(`${allData.length.toLocaleString()} rows loaded. Use the search above.`);
        },
        error: (err) => {
          console.error(err);
          el('loading-text').textContent = '❌ Failed to parse data.csv';
          setKPI('Failed to parse data.csv.');
        }
      });
    } catch(err){
      console.error(err);
      el('loading-text').textContent = '❌ Failed to load data.csv';
      el('loading-detail').textContent = err.message || String(err);
      setKPI('Failed to load data.csv — ensure the file exists next to this page.');
    }
  })();

  // ====== Wire up controls ======
  el('q').addEventListener('input', debounce(applyFilters, 250));
  el('val').addEventListener('input', debounce(applyFilters, 250));
  el('col').addEventListener('change', applyFilters);
  el('clear').addEventListener('click', () => {
    el('q').value = '';
    el('val').value = '';
    el('col').value = '';
    if(table){ table.clearFilter(true); table.setData(allData); setKPI(`${allData.length.toLocaleString()} rows loaded.`); }
  });
</script>
</body>
</html>
