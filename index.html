<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Phage Genomes (9Aug2025 Millard Lab)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bd:#ddd; --bg:#f7f7f7; --fs:14px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
  h1 { margin: 0 0 8px; font-size: 1.1rem; }
  #status { margin: 6px 0 10px; white-space: pre-wrap; font-size: 0.95rem; color:#333; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 12px; }
  input[type="search"] { padding:8px; font-size:var(--fs); width: min(520px, 100%); }
  button { padding:8px 12px; font-size:var(--fs); cursor:pointer; }
  .meta { font-size:0.9rem; color:#555; }
  .table-wrap { border:1px solid var(--bd); border-radius:8px; overflow:auto; height:70vh; position:relative; }
  .row { display:table; table-layout:fixed; width:100%; }
  .cell, .headcell { display:table-cell; padding:6px 8px; border-bottom:1px solid var(--bd); vertical-align:top; }
  .headcell {
    background:#e0ecff;       /* header colour */
    font-weight:bold;
    position:sticky;
    top:0;
    z-index:2;
    border-bottom:2px solid #999;
  }
  .spacer { height:0px; }
  .muted { color:#777; }
  a { color: #0645ad; text-decoration: underline; }
</style>
</head>
<body>
<h1>Phage Genomes – 9Aug2025 Millard Lab</h1>
<div id="status">Loading…</div>

<div class="controls">
  <input id="search" type="search" placeholder="Type to filter rows…" aria-label="Filter table" />
  <button id="download" type="button">Download filtered (.tsv)</button>
  <span id="stats" class="meta"></span>
</div>

<div class="table-wrap" id="view">
  <div id="header" class="row"></div>
  <div id="top-spacer" class="spacer"></div>
  <div id="viewport"></div>
  <div id="bottom-spacer" class="spacer"></div>
</div>

<script>
/*** CONFIG ***/
// const DATA_FILE = "9Aug2025_millardlab_website_table.txt";
const DATA_FILE = "9Aug2025_millardlab_website_table.txt.gz"; // if gzipped
/**************/

const $ = sel => document.querySelector(sel);
const statusEl = $('#status');
const statsEl  = $('#stats');
const searchEl = $('#search');
const viewEl   = $('#view');
const headEl   = $('#header');
const vpEl     = $('#viewport');
const topSpacer= $('#top-spacer');
const botSpacer= $('#bottom-spacer');

function log(msg){ statusEl.textContent = msg; }
function fmt(num){ return num.toLocaleString(); }
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

let headers = [];
let rows = [];
let filteredIdx = null;
let rowHeight = 28;
const overscan = 10;

/*** FETCH with gzip support ***/
async function fetchTextSmart(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} for ${url}`);

  if (url.endsWith(".gz") && "DecompressionStream" in window) {
    const ds = new DecompressionStream("gzip");
    const decompressed = res.body.pipeThrough(ds);
    return await new Response(decompressed).text();
  }
  return await res.text();
}

function parseTSV(text){
  const lines = text.replace(/\r/g,'').split('\n');
  while(lines.length && !lines[0].trim()) lines.shift();
  if(!lines.length) throw new Error('Empty file');
  headers = lines[0].split(/\t/);
  const out = [];
  for (let i=1;i<lines.length;i++){
    const L = lines[i];
    if (!L) continue;
    const cols = L.split(/\t/);
    while (cols.length < headers.length) cols.push('');
    out.push(cols.slice(0, headers.length));
  }
  return out;
}

function renderHeader(){
  headEl.className = 'row';
  headEl.innerHTML = '';
  headers.forEach(h=>{
    const d = document.createElement('div');
    d.className='headcell';
    d.textContent = h;
    headEl.appendChild(d);
  });
  headEl.style.display='grid';
  headEl.style.gridAutoFlow='column';
  headEl.style.gridAutoColumns='1fr';
}

function measureRowHeight(){
  const sample = document.createElement('div');
  sample.className='row';
  sample.style.display='grid';
  sample.style.gridAutoFlow='column';
  sample.style.gridAutoColumns='1fr';
  const r = rows[0] || headers.map(()=>'-');
  r.forEach(v=>{
    const c = document.createElement('div');
    c.className='cell';
    c.innerHTML = v;
    sample.appendChild(c);
  });
  vpEl.appendChild(sample);
  rowHeight = Math.ceil(sample.getBoundingClientRect().height || rowHeight);
  vpEl.removeChild(sample);
}

function getActiveIndexList(){
  return filteredIdx ?? rows.map((_,i)=>i);
}

function renderWindow(){
  const idxList = getActiveIndexList();
  const total = idxList.length;
  const scrollTop = viewEl.scrollTop - headEl.offsetHeight;
  const innerHeight = viewEl.clientHeight - headEl.offsetHeight;
  const start = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);
  const end = Math.min(total, Math.ceil((scrollTop + innerHeight) / rowHeight) + overscan);

  topSpacer.style.height = (start * rowHeight) + 'px';
  botSpacer.style.height = ((total - end) * rowHeight) + 'px';

  const frag = document.createDocumentFragment();
  for (let i=start; i<end; i++){
    const r = rows[idxList[i]];
    const rowDiv = document.createElement('div');
    rowDiv.className='row';
    rowDiv.style.display='grid';
    rowDiv.style.gridAutoFlow='column';
    rowDiv.style.gridAutoColumns='1fr';
    for (let j=0;j<headers.length;j++){
      const cell = document.createElement('div');
      cell.className='cell';
      cell.innerHTML = r[j] ?? '';
      rowDiv.appendChild(cell);
    }
    frag.appendChild(rowDiv);
  }
  vpEl.replaceChildren(frag);

  statsEl.textContent = `Rows: ${fmt(rows.length)} | Showing: ${fmt(total)} | Visible: ${fmt(end-start)}`;
}

function applyFilter(q){
  if (!q) { filteredIdx = null; renderWindow(); return; }
  const needle = q.toLowerCase();
  const out = [];
  for (let i=0;i<rows.length;i++){
    const r = rows[i];
    if ((r._j ?? (r._j = r.join('\t').toLowerCase())).includes(needle)){
      out.push(i);
    }
  }
  filteredIdx = out;
  renderWindow();
}

/*** DOWNLOAD filtered rows ***/
function cellToText(cellHtml){
  if (!cellHtml) return '';
  const tmp = document.createElement('div');
  tmp.innerHTML = cellHtml;
  const a = tmp.querySelector('a');
  if (a && a.getAttribute('href')) return a.href.trim();
  return tmp.textContent.trim();
}

function buildTSV(headers, rowIdxList){
  const parts = [];
  parts.push(headers.join('\t'));
  for (const i of rowIdxList){
    const r = rows[i];
    const cols = [];
    for (let j=0; j<headers.length; j++){
      const val = cellToText(r[j] ?? '');
      cols.push(val.replace(/\t/g,' ').replace(/\r?\n/g,' '));
    }
    parts.push(cols.join('\t'));
  }
  return parts.join('\n');
}

function downloadFilteredTSV(){
  const idxList = getActiveIndexList();
  if (!idxList.length){
    alert('No rows to download.');
    return;
  }
  const tsv = buildTSV(headers, idxList);
  const blob = new Blob([tsv], { type: 'text/tab-separated-values;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,10);
  const fname = `phage_genomes_filtered_${ts}.tsv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/*** EVENT LISTENERS ***/
viewEl.addEventListener('scroll', () => { requestAnimationFrame(renderWindow); });
const debouncedFilter = debounce((ev)=>applyFilter(ev.target.value), 200);
searchEl.addEventListener('input', debouncedFilter);
document.getElementById('download').addEventListener('click', downloadFilteredTSV);

/*** INIT ***/
(async () => {
  try {
    log(`Fetching ${DATA_FILE} …`);
    const text = await fetchTextSmart(DATA_FILE);
    log('Parsing…');
    rows = parseTSV(text);
    renderHeader();
    measureRowHeight();
    renderWindow();
    log(`Loaded ${DATA_FILE} – ${fmt(rows.length)} rows, ${headers.length} columns. Scroll to browse; use search to filter.`);
  } catch (e) {
    log(`❌ Could not load ${DATA_FILE}: ${e.message}\nChecklist:\n• Ensure ${DATA_FILE} is in the same folder as index.html\n• First line is a header row`);
  }
})();
</script>
</body>
</html>
