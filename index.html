<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Phage Genomes Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jQuery 3.7.1 with correct SRI -->
  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>

  <!-- DataTables CSS (version pinned). DataTables’ CDN doesn’t publish stable SRI; omit integrity here. -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px}
    h1{font-size:1.25rem;margin:0 0 12px}
    #status{margin:12px 0;white-space:pre-wrap}
    .wrap{overflow-x:auto}
    table.dataTable thead th{white-space:nowrap}
  </style>
</head>
<body>
  <h1>Phage Genomes</h1>
  <p>This page loads <code>data.tsv</code> or <code>data.csv</code> from this repository and makes it searchable.</p>
  <div id="status">Loading…</div>
  <div class="wrap"><table id="tbl" class="display" style="width:100%"></table></div>

  <!-- DataTables JS (version pinned). No SRI due to upstream policy. -->
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <script>
    const candidates = [
      {url:'9Aug2025_data.tsv', delim:'\t'},
      {url:'data.csv', delim:','}
    ];

    async function fetchText(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} for ${url}`);
      return await res.text();
    }

    function parseTable(text, delim){
      const lines = text.replace(/\r/g,'').trim().split('\n').filter(x=>x.trim().length);
      if(!lines.length) throw new Error('Empty file');
      const headers = lines[0].split(delim);
      const data = lines.slice(1).map(line=>{
        const cols = line.split(delim);
        while(cols.length < headers.length) cols.push('');
        return cols.slice(0, headers.length);
      });
      return { headers, data };
    }

    async function loadFirstAvailable(){
      let lastErr = null;
      for(const c of candidates){
        try{
          const txt = await fetchText(c.url);
          const parsed = parseTable(txt, c.delim);
          return { ...parsed, used:c.url };
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('No data file found');
    }

    (async ()=>{
      const status = document.getElementById('status');
      try{
        const { headers, data, used } = await loadFirstAvailable();
        status.textContent = `Loaded ${used} (${data.length} rows)`;
        const columns = headers.map(h => ({ title: h }));
        $('#tbl').DataTable({
          data, columns,
          pageLength: 25,
          deferRender: true,
          processing: true,
          autoWidth: false,
          scrollX: true
        });
      }catch(err){
        status.textContent =
          `❌ Could not load data: ${err.message}\n\n` +
          `Checklist:\n• Open this via Pages (https://amillard.github.io/phage_genomes/)\n` +
          `• Put index.html + data.tsv (or data.csv) in the same published folder\n` +
          `• First line of the file must be a header row`;
      }
    })();
  </script>
</body>
</html>
